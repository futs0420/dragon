<!DOCTYPE script PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" type="text/css"
	href="${rc.contextPath}/js/jquery-easyui-1.4.3/themes/default/easyui.css">
<link rel="stylesheet" type="text/css"
	href="${rc.contextPath}/js/jquery-easyui-1.4.3/themes/icon.css">
<script type="text/javascript"
	src="${rc.contextPath}/js/jquery-1.11.3.min.js"></script>
<script type="text/javascript"
	src="${rc.contextPath}/js/jquery.easyui.min.js"></script>
<script type="text/javascript">
	function submitForm() {
		$('#newJobForm').form('submit',{url:"../job/saveJob.do"});
		refreshJob();
	}

	function clearForm() {
		$('#newJobForm').form('clear');
	}

	function newJob() {
		$('#newJob').window('open');
	}

	function operateFormater(value, row, index) {
		var operate = "<a href='javascript:void(0)' class='easyui-linkbutton' onclick='triggerNow("
				+ row.jobId + ")'>立即执行</a> ";
		operate += "<a href='javascript:void(0)' class='easyui-linkbutton' onclick='delJob("
				+ row.jobId + ")'>删除</a> ";
		if (row.jobExecuteStatus == 0) {
			operate += "<a href='javascript:void(0)' class='easyui-linkbutton' onclick='pauseJob("
					+ row.jobId + ")'>暂停</a> ";
		}
		if (row.jobExecuteStatus == 1) {
			operate += "<a href='javascript:void(0)' class='easyui-linkbutton' onclick='resumeJob("
					+ row.jobId + ")'>恢复</a> ";
		}
		return operate;
	}

	function executeStatusFormater(value, row, index) {
		var result = "";
		if (value == 0) {
			result = "正常";
		} else if (value == 1) {
			result = "暂停";
		} else if (value == 2) {
			result = "完成";
		} else if (value == 3) {
			result = "错误";
		} else if (value == 4) {
			result = "阻塞";
		} else if (value == -1) {
			result = "触发器不存在";
		}
		return result;
	}

	function triggerNow(jobId) {
		if (confirm("确定要立即执行该任务吗？")) {
			var url = "../job/triggerJob.do";
			$.post(url, {
				jobId : jobId
			}, function(data) {
				if (data.result) {
					alert("操作成功");
					refreshJob();
				} else {
					alert("操作失败");
				}
			}, "json");
		}
	}

	function delJob(jobId) {
		if (confirm("确定要删除吗？")) {
			var url = "../job/deleteJob.do";
			$.post(url, {
				jobId : jobId
			}, function(data) {
				if (data.result) {
					alert("操作成功");
					refreshJob();
				} else {
					alert("操作失败");
				}
			}, "json");
		}
	}

	function pauseJob(jobId) {
		if (confirm("确定要暂停吗？")) {
			var url = "../job/pauseJob.do";
			$.post(url, {
				jobId : jobId
			}, function(data) {
				if (data.result) {
					alert("操作成功");
					refreshJob();
				} else {
					alert("操作失败");
				}
			}, "json");
		}
	}

	function resumeJob(jobId) {
		if (confirm("确定要恢复吗？")) {
			var url = "../job/resumeJob.do";
			$.post(url, {
				jobId : jobId
			}, function(data) {
				if (data.result) {
					alert("操作成功");
					refreshJob();
				} else {
					alert("操作失败");
				}
			}, "json");
		}
	}

	function refreshJob() {
		$('#allJob').datagrid('reload');
		$('#executingJob').datagrid('reload');
	}

	function selectTab(title, index) {
		refreshJob();
	}

	$.extend($.fn.datagrid.methods, {
		editCell : function(jq, param) {
			return jq.each(function() {
				var opts = $(this).datagrid('options');
				var fields = $(this).datagrid('getColumnFields', true).concat(
						$(this).datagrid('getColumnFields'));
				for (var i = 0; i < fields.length; i++) {
					var col = $(this).datagrid('getColumnOption', fields[i]);
					col.editor1 = col.editor;
					if (fields[i] != param.field) {
						col.editor = null;
					}
				}
				$(this).datagrid('beginEdit', param.index);
				for (var i = 0; i < fields.length; i++) {
					var col = $(this).datagrid('getColumnOption', fields[i]);
					col.editor = col.editor1;
				}
			});
		}
	});

	var editIndex = undefined;
	function endEditing() {
		if (editIndex == undefined) {
			return true
		}
		if ($('#allJob').datagrid('validateRow', editIndex)) {
			$('#allJob').datagrid('endEdit', editIndex);
			editIndex = undefined;
			return true;
		} else {
			return false;
		}
	}

	function onClickCell(index, field, value) {
		if (endEditing()) {
			$('#allJob').datagrid('selectRow', index).datagrid('editCell', {
				index : index,
				field : field
			});
			editIndex = index;
		}
	}

	function onAfterEdit(index, row, changes) {
		// changes的属性数量大于0 表示有改动
		if (Object.getOwnPropertyNames(changes).length > 0) {
			changes["jobId"] = row.jobId;
			alert(changes.jobId);
			var url = "../job/saveJob.do";
			$.post(url, changes, function(data) {
				if (data.result) {
					alert("操作成功");
					refreshJob();
				} else {
					alert("操作失败");
				}
			}, "json");
		}
	}
</script>
</head>
<body>
	<div class="easyui-tabs" style="width: 100%; height: 700px;">
		<div title="所有任务"
			data-options="iconCls:'icon-reload',closable:false,
			onSelect:selectTab"
			style="padding: 10px;">
			<div id="toolbar">
				<a href="#" class="easyui-linkbutton" iconCls="icon-add"
					plain="true" onclick="newJob()">新增任务</a> <a href="#"
					class="easyui-linkbutton" iconCls="icon-reload" plain="true"
					onclick="refreshJob()">刷新任务</a>
			</div>
			<table id="allJob" title="所有任务" class="easyui-datagrid"
				style="width: 98%; height: 620px;"
				data-options="iconCls: 'icon-edit',	singleSelect: true,
					url: '../job/queryJobList.do',method:'get',
					rownumbers:true,onClickCell: onClickCell,onAfterEdit:onAfterEdit,fitColumns:true,
					pagination:true">
				<thead>
					<tr>
						<th data-options="align:'center',field:'jobId',width:30">ID</th>
						<th
							data-options="align:'center',field:'jobName',width:80,editor:'text'">名称</th>
						<th
							data-options="align:'center',field:'jobGroup',width:80,editor:'text'">分组</th>
						<th
							data-options="align:'center',field:'jobStatus',width:40,editor:{type:'numberbox'}">状态</th>
						<th
							data-options="align:'center',field:'jobExecuteStatus',width:60,formatter:executeStatusFormater">运行状态</th>
						<th
							data-options="align:'center',field:'jobInvokeClass',width:200,editor:'text'">运行的类</th>
						<th
							data-options="align:'center',field:'jobCronExpression',width:100,editor:'text'">表达式</th>
						<th data-options="align:'center',field:'preFireTime',width:130">上次触发时间</th>
						<th data-options="align:'center',field:'nextFireTime',width:130">下次触发时间</th>
						<th data-options="align:'center',field:'jobNote',width:130">备注</th>
						<th
							data-options="align:'center',field:'operate',formatter:operateFormater">操作</th>
					</tr>
				</thead>
			</table>


		</div>
		<div title="运行中的任务"
			data-options="iconCls:'icon-reload',closable:false,
			onSelect:selectTab"
			style="overflow: auto; padding: 10px;">
			<div id="toolbar">
				<a href="#" class="easyui-linkbutton" iconCls="icon-reload"
					plain="true" onclick="refreshJob()">刷新任务</a>
			</div>
			<table id="executingJob" title="运行中的任务" class="easyui-datagrid"
				style="width: 100%; height: 620px"
				url="../job/queryExecutingJobList.do" rownumbers="true"
				fitColumns="true" singleSelect="true" pagination="true">
				<thead>
					<tr>
						<th field="jobName" width="25" align="center">名称</th>
						<th field="jobGroup" width="25" align="center">分组</th>
						<th field="jobInvokeClass" width="60" align="center">运行的类</th>
						<th field="jobCronExpression" width="25" align="center">表达式</th>
						<th field="preFireTime" width="35" align="center">上次触发时间</th>
						<th field="nextFireTime" width="35" align="center">下次触发时间</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>

	<div id="newJob" class="easyui-window" title="新增任务"
		data-options="modal:true,closed:true,iconCls:'icon-save'"
		style="width: 600px; height: 450px; padding: 10px;">
		<form id="newJobForm">
			<table cellpadding="5">
				<tr>
					<td align="right">规则ID:</td>
					<td><input class="easyui-textbox" type="text" name="jobId"></input></td>
				</tr>
				<tr>
					<td align="right">规则名称:</td>
					<td><input class="easyui-textbox" type="text" name="jobName"
						data-options="required:true" value="test-name"></input></td>
				</tr>
				<tr>
					<td align="right">规则分组:</td>
					<td><input class="easyui-textbox" type="text" name="jobGroup"
						data-options="required:true" value="test-group"></input></td>
				</tr>
				<tr>
					<td align="right">规则状态:</td>
					<td><input class="easyui-textbox" type="text" name="jobStatus"
						data-options="required:true" value="1"></input></td>
				</tr>
				<tr>
					<td align="right">规则类:</td>
					<td><input class="easyui-textbox" type="text"
						name="jobInvokeClass" data-options="required:true"
						value="com.dragon.web.job.TestJob"></input></td>
				</tr>
				<tr>
					<td align="right">规则触发表达式:</td>
					<td><input class="easyui-textbox" type="text"
						name="jobCronExpression" data-options="required:true"
						value="0 0/8 * * * ?"></input></td>
				</tr>
				<tr>
					<td align="right">规则备注:</td>
					<td><input class="easyui-textbox" type="text" name="jobNote"
						data-options="multiline:true,required:false"
						style="width: 300px; height: 100px"></input></td>
				</tr>
			</table>
		</form>
		<div style="text-align: center; padding: 5px">
			<a href="javascript:void(0)" class="easyui-linkbutton"
				onclick="submitForm()">提交</a> <a href="javascript:void(0)"
				class="easyui-linkbutton" onclick="clearForm()">重置</a>
		</div>
	</div>
</body>
</html>